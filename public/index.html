<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp API</title>
    <style>
        body { 
            font-family: monospace;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        
        h1 { color: #58a6ff; margin-bottom: 5px; }
        h3 { color: #58a6ff; margin: 20px 0 10px 0; }
        .subtitle { color: #8b949e; margin-bottom: 30px; }
        
        .section {
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            font-family: monospace;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            padding: 10px 16px;
            margin: 5px;
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            cursor: pointer;
            border-radius: 6px;
        }
        
        button:hover { background: #30363d; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-primary:hover { background: #2ea043; }
        
        #qrImage {
            max-width: 300px;
            margin: 20px auto;
            display: block;
            border: 2px solid #30363d;
            border-radius: 6px;
        }
        
        .qr-container {
            text-align: center;
            padding: 20px;
            border: 1px solid #30363d;
            border-radius: 6px;
            display: none;
        }
        
        .qr-status { 
            margin-top: 10px; 
            color: #58a6ff;
        }
        
        #output {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            color: #7ee787;
            font-size: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            padding: 15px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #161b22;
        }
        
        .stat-number { 
            font-size: 28px; 
            color: #58a6ff;
            font-weight: bold;
        }
        
        .stat-label { 
            font-size: 12px; 
            color: #8b949e;
            margin-top: 5px;
        }

        .session-list {
            margin: 10px 0;
        }

        .session-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #161b22;
            cursor: pointer;
        }

        .session-item:hover {
            background: #21262d;
        }

        .session-item.selected {
            border-color: #58a6ff;
            background: #1c2532;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .badge-success { background: #238636; color: white; }
        .badge-warning { background: #9e6a03; color: white; }
        .badge-danger { background: #da3633; color: white; }
    </style>
</head>
<body>
    <h1>WhatsApp API Dashboard</h1>
    <p class="subtitle">Sistema de gesti√≥n con Redis y estad√≠sticas</p>

    <!-- SECCI√ìN 1: Crear/Ver Sesiones -->
    <div class="section">
        <h3>1Ô∏è‚É£ Gesti√≥n de Sesiones</h3>
        <input type="text" id="newSessionName" placeholder="Nombre de nueva sesi√≥n" value="default">
        <button class="btn-primary" onclick="createSession()">Crear Sesi√≥n / Obtener QR</button>
        <button onclick="loadSessions()">üîÑ Recargar Sesiones</button>
        
        <div id="sessionsList" class="session-list"></div>
        
        <div class="qr-container" id="qrContainer">
            <div>Escanea el c√≥digo QR</div>
            <img id="qrImage" src="" style="display: none;">
            <div class="qr-status" id="qrStatus"></div>
        </div>
        
        <div style="margin-top: 12px;">
            <button onclick="captureScreenshot()">üì∏ Capturar pantalla (sesi√≥n seleccionada)</button>
            <div style="margin-top:10px; text-align:center;">
                <img id="screenshotImage" src="" alt="Screenshot" style="max-width:100%; border:1px solid #30363d; border-radius:6px; display:none; margin-top:10px;" />
            </div>
        </div>
    </div>

    <!-- SECCI√ìN 2: Test de Mensaje -->
    <div class="section">
        <h3>2Ô∏è‚É£ Enviar Mensaje de Prueba</h3>
        <select id="testSessionSelect">
            <option value="">Selecciona una sesi√≥n</option>
        </select>
        <input type="text" id="testPhone" placeholder="N√∫mero (ej: 987654321)">
        <textarea id="testMessage" placeholder="Escribe tu mensaje de prueba aqu√≠..."></textarea>
        <button class="btn-primary" onclick="sendTestMessage()">üì§ Enviar Mensaje</button>
    </div>

    <!-- SECCI√ìN 3: Ver Colas -->
    <div class="section">
        <h3>3Ô∏è‚É£ Estado de Colas y Estad√≠sticas</h3>
        <button onclick="loadAllQueues()">üìä Ver Todas las Colas</button>
        <button onclick="loadAllStats()">üìà Ver Estad√≠sticas</button>
        
        <div id="queuesContainer" class="stats-grid"></div>
    </div>

    <!-- Output Console -->
    <div class="section">
        <h3>üìã Console</h3>
        <pre id="output">Esperando comandos...</pre>
    </div>

    <script>
        let selectedSession = null;
        let autoRefreshInterval = null;

        const output = document.getElementById('output');
        const qrImage = document.getElementById('qrImage');
        const qrContainer = document.getElementById('qrContainer');
        const qrStatus = document.getElementById('qrStatus');

        function log(data, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : type === 'success' ? '[OK]' : '[INFO]';
            output.textContent = `${timestamp} ${prefix}\n${JSON.stringify(data, null, 2)}`;
        }

        // ===== GESTI√ìN DE SESIONES =====
        async function createSession() {
            const name = document.getElementById('newSessionName').value.trim();
            if (!name) {
                alert('Ingresa un nombre de sesi√≥n');
                return;
            }

            log('Creando sesi√≥n...');
            qrContainer.style.display = 'none';

            try {
                const response = await fetch('/whatsapp/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await response.json();

                if (response.ok && data.qrCode) {
                    qrImage.src = data.qrCode;
                    qrImage.style.display = 'block';
                    qrContainer.style.display = 'block';
                    qrStatus.innerHTML = 'Esperando escaneo... <span class="loading"></span>';
                    log(data, 'success');
                    startAutoRefresh(name);
                } else if (response.ok && data.isAuthenticated) {
                    log(data, 'success');
                    qrStatus.innerHTML = '‚úì Ya autenticado';
                } else {
                    log(data, 'error');
                }

                loadSessions();
            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/whatsapp/sessions');
                const data = await response.json();
                
                const container = document.getElementById('sessionsList');
                const select = document.getElementById('testSessionSelect');
                
                if (data.sessions.length === 0) {
                    container.innerHTML = '<div style="color: #8b949e; padding: 10px;">No hay sesiones activas</div>';
                    select.innerHTML = '<option value="">No hay sesiones</option>';
                    return;
                }

                container.innerHTML = data.sessions.map(s => `
                    <div class="session-item ${selectedSession === s.name ? 'selected' : ''}" 
                         onclick="selectSession('${s.name}')">
                        <strong>${s.name}</strong>
                        ${s.isAuthenticated 
                            ? '<span class="badge badge-success">Autenticado</span>' 
                            : '<span class="badge badge-warning">Pendiente</span>'}
                    </div>
                `).join('');

                select.innerHTML = '<option value="">Selecciona sesi√≥n</option>' +
                    data.sessions
                        .filter(s => s.isAuthenticated)
                        .map(s => `<option value="${s.name}">${s.name}</option>`)
                        .join('');

            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        function selectSession(name) {
            selectedSession = name;
            loadSessions();
            log({ message: `Sesi√≥n '${name}' seleccionada` }, 'info');
        }

        async function captureScreenshot() {
            const name = selectedSession || document.getElementById('newSessionName').value.trim();
            if (!name) {
                alert('Selecciona una sesi√≥n o ingresa su nombre');
                return;
            }

            log(`Solicitando screenshot para sesi√≥n '${name}'...`);

            try {
                const res = await fetch(`/whatsapp/sessions/${encodeURIComponent(name)}/screenshot`);
                if (!res.ok) {
                    const txt = await res.text();
                    log({ error: `Error: ${res.status} ${txt}` }, 'error');
                    return;
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('screenshotImage');
                img.src = url;
                img.style.display = 'block';
                log({ message: 'Screenshot recibido.' }, 'success');
            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        // ===== TEST DE MENSAJE =====
        async function sendTestMessage() {
            const session = document.getElementById('testSessionSelect').value;
            const phone = document.getElementById('testPhone').value.trim();
            const message = document.getElementById('testMessage').value.trim();

            if (!session || !phone || !message) {
                alert('Completa todos los campos');
                return;
            }

            log('Enviando mensaje de prueba...');

            try {
                const response = await fetch(`/whatsapp/sessions/${session}/send-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone, message })
                });
                const data = await response.json();
                log(data, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    document.getElementById('testMessage').value = '';
                }
            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        // ===== COLAS Y ESTAD√çSTICAS =====
        async function loadAllQueues() {
            log('Cargando colas...');
            try {
                const response = await fetch('/whatsapp/queues');
                const queues = await response.json();

                const statsResponse = await fetch('/whatsapp/stats');
                const stats = await statsResponse.json();

                const container = document.getElementById('queuesContainer');
                
                if (queues.length === 0) {
                    container.innerHTML = '<div style="color: #8b949e;">No hay colas activas</div>';
                    return;
                }

                container.innerHTML = queues.map(q => {
                    const sessionStats = stats.find(s => s.sessionName === q.sessionName);
                    const todayCount = sessionStats?.today?.count || 0;

                    return `
                        <div class="stat-card">
                            <strong>${q.sessionName}</strong>
                            <div style="margin: 10px 0; padding: 10px 0; border-top: 1px solid #30363d; border-bottom: 1px solid #30363d;">
                                <div class="stat-number">${q.pending}</div>
                                <div class="stat-label">En cola</div>
                            </div>
                            <div style="font-size: 12px; color: #8b949e;">
                                ‚è±Ô∏è ${q.estimatedTime?.formatted || 'N/A'}<br>
                                üìä Hoy: ${todayCount} mensajes<br>
                                ${q.isProcessing ? 'üü¢ Activo' : 'üî¥ Inactivo'}
                            </div>
                        </div>
                    `;
                }).join('');

                log({ queues, stats }, 'success');
            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        async function loadAllStats() {
            log('Cargando estad√≠sticas...');
            try {
                const response = await fetch('/whatsapp/stats');
                const stats = await response.json();

                const container = document.getElementById('queuesContainer');
                
                container.innerHTML = stats.map(s => `
                    <div class="stat-card">
                        <strong>${s.sessionName}</strong>
                        <div style="margin: 10px 0;">
                            <div class="stat-number">${s.today.count}</div>
                            <div class="stat-label">Mensajes hoy (${s.today.date})</div>
                        </div>
                        <div style="font-size: 11px; color: #8b949e;">
                            √öltimos 7 d√≠as:<br>
                            ${s.last7Days.slice(0, 3).map(d => 
                                `${d.date.split('-')[2]}: ${d.count}`
                            ).join(' | ')}
                        </div>
                    </div>
                `).join('');

                log(stats, 'success');
            } catch (error) {
                log({ error: error.message }, 'error');
            }
        }

        // ===== AUTO-REFRESH QR =====
        function startAutoRefresh(sessionName) {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/whatsapp/sessions/${sessionName}/qr`);
                    const data = await response.json();
                    
                    if (data.isAuthenticated) {
                        qrStatus.innerHTML = '‚úì Autenticaci√≥n completada';
                        qrImage.style.display = 'none';
                        stopAutoRefresh();
                        loadSessions();
                    }
                } catch (error) {
                    console.error('Error auto-refresh:', error);
                }
            }, 3000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // ===== INIT =====
        window.onload = () => {
            loadSessions();
            loadAllQueues();
        };

        window.onbeforeunload = () => {
            stopAutoRefresh();
        };

        // Auto-refresh cada 5 segundos
        setInterval(() => {
            loadAllQueues();
        }, 5000);
    </script>
</body>
</html>