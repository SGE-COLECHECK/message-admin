services:
  app:
    build: .
    container_name: whatsapp_app
    restart: always
    ports:
      - "3000:3000"
    env_file:
      # Aseg√∫rate de que este archivo coincida con tu NODE_ENV
      #- .env.production # O 
      - .env.development
    environment:
      # Redis
      #- REDIS_HOST=redis
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - NODE_ENV=production # Debe coincidir con el archivo de env_file
      
      # Queue
      - QUEUE_RETRY_ATTEMPTS=3
      - QUEUE_RETRY_DELAY=5000
      - QUEUE_PROCESSING_INTERVAL=1000
    
      # Puppeteer Performance
      - PUPPETEER_WAIT_FOR_UI_TIMEOUT=5000
      - PUPPETEER_TYPING_DELAY=50
      - PUPPETEER_AFTER_CLICK_DELAY=150

      # Puppeteer host para conectar desde Docker (en WSL) a un navegador en Windows
      - PUPPETEER_BROWSER_HOST=host.docker.internal
      
      # Feature Flags
      - USE_QUEUE=true
      
      # üî¥ CR√çTICO: Configuraci√≥n de Chromium
      # - DISPLAY=:99 # <-- Eliminado, no es necesario en modo headless
      - CHROME_DEVEL_SANDBOX=/usr/lib/chromium/chrome-sandbox
    volumes:
      - ./profiles:/app/profiles:rw
      - ./wwebjs_auth:/app/.wwebjs_auth:rw
      - ./public:/app/public:ro
      - /etc/localtime:/etc/localtime:ro
    shm_size: 2gb
    init: true
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      # ‚úÖ CORREGIDO: Usa node para verificar un endpoint de salud
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: whatsapp_redis_queue
    restart: always
    # ‚ö†Ô∏è CONSIDERACI√ìN: Elimina el mapeo de puertos en producci√≥n
    ports:
      - "6379:6379" 
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  redis_data:
    driver: local